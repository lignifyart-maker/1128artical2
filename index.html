<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ–‡ç« åˆä½µå™¨</title>
    <meta name="description" content="ä½¿ç”¨ AI æ™ºèƒ½åˆä½µå¤šç¯‡æ–‡ç« ï¼Œå‰µä½œå‡ºé‚è¼¯é€£è²«çš„é•·æ–‡">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font is used by default, but Noto Sans TC is crucial for Traditional Chinese -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <style>
        /* Custom styles to enforce Noto Sans TC and smooth transitions */
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f7f9fb;
            /* Light background */
        }

        .title-icon {
            transform: rotate(-5deg);
            display: inline-block;
        }

        /* Loading Spinner Animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #10b981;
            /* Emerald green */
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Toast Notification Styling */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
        }

        .toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>

<body class="p-4 md:p-8">
    <div class="container mx-auto max-w-7xl">

        <!-- Header Section -->
        <header class="header text-center mb-10 bg-white p-6 rounded-xl shadow-lg">
            <h1 class="text-4xl font-bold text-gray-800 flex justify-center items-center">
                <span class="title-icon mr-3 text-4xl">ğŸ“</span>
                AI æ–‡ç« åˆä½µå™¨
            </h1>
            <p class="text-xl text-gray-500 mt-2">æ™ºèƒ½åˆä½µå¤šç¯‡æ–‡ç« ï¼Œå‰µä½œé€£è²«é•·æ–‡</p>
        </header>

        <main class="main-content">

            <!-- Input Section -->
            <div class="input-section mb-12">
                <h2 class="section-title text-2xl font-semibold text-gray-700 mb-6 flex items-center">
                    <span class="icon mr-2 text-3xl">âœï¸</span>
                    è¼¸å…¥æ–‡ç« ç‰‡æ®µ
                    <span
                        class="hint ml-4 text-base font-normal text-indigo-500 bg-indigo-50 p-1 px-3 rounded-full shadow-inner">
                        ï¼ˆAI æœƒåœ¨æ®µè½é–“æ“´å¯«å…§å®¹ï¼Œè«‹æä¾›è¶³å¤ è³‡è¨Šè®“ AI å‰µä½œï¼‰
                    </span>
                </h2>

                <div class="input-grid grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <!-- Article Input 1 -->
                    <div class="input-card bg-white p-5 rounded-xl shadow-md border-t-4 border-green-500">
                        <div class="input-header flex justify-between items-center mb-3">
                            <label for="article1"
                                class="input-label flex items-center text-lg font-medium text-gray-700">
                                <span
                                    class="label-number bg-green-500 text-white w-7 h-7 flex items-center justify-center rounded-full mr-2 font-bold">1</span>
                                <span class="label-text">ç¬¬ä¸€ç¯‡æ–‡ç«  (å¿…å¡«)</span>
                            </label>
                            <div class="input-controls flex items-center space-x-2">
                                <span id="counter1" class="char-counter text-sm text-gray-500">0 å­—</span>
                                <button
                                    class="control-btn clear-btn text-gray-400 hover:text-red-500 transition duration-150"
                                    data-field="1" title="æ¸…é™¤">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.728-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <textarea id="article1"
                            class="input-textarea w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 resize-y transition duration-150"
                            placeholder="è²¼ä¸Šæˆ–è¼¸å…¥æ–‡ç« çš„é–‹é ­å…§å®¹..." rows="10"></textarea>
                    </div>

                    <!-- Article Input 2 -->
                    <div class="input-card bg-white p-5 rounded-xl shadow-md border-t-4 border-green-500">
                        <div class="input-header flex justify-between items-center mb-3">
                            <label for="article2"
                                class="input-label flex items-center text-lg font-medium text-gray-700">
                                <span
                                    class="label-number bg-green-500 text-white w-7 h-7 flex items-center justify-center rounded-full mr-2 font-bold">2</span>
                                <span class="label-text">ç¬¬äºŒç¯‡æ–‡ç«  (å¿…å¡«)</span>
                            </label>
                            <div class="input-controls flex items-center space-x-2">
                                <span id="counter2" class="char-counter text-sm text-gray-500">0 å­—</span>
                                <button
                                    class="control-btn clear-btn text-gray-400 hover:text-red-500 transition duration-150"
                                    data-field="2" title="æ¸…é™¤">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.728-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <textarea id="article2"
                            class="input-textarea w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 resize-y transition duration-150"
                            placeholder="è²¼ä¸Šæˆ–è¼¸å…¥æ–‡ç« çš„ä¸­é–“å…§å®¹..." rows="10"></textarea>
                    </div>

                    <!-- Article Input 3 (Optional) -->
                    <div class="input-card bg-white p-5 rounded-xl shadow-md border-t-4 border-yellow-500">
                        <div class="input-header flex justify-between items-center mb-3">
                            <label for="article3"
                                class="input-label flex items-center text-lg font-medium text-gray-700">
                                <span
                                    class="label-number bg-yellow-500 text-white w-7 h-7 flex items-center justify-center rounded-full mr-2 font-bold">3</span>
                                <span class="label-text">ç¬¬ä¸‰ç¯‡æ–‡ç« </span>
                                <span
                                    class="optional-tag ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full font-semibold">é¸å¡«</span>
                            </label>
                            <div class="input-controls flex items-center space-x-2">
                                <span id="counter3" class="char-counter text-sm text-gray-500">0 å­—</span>
                                <button
                                    class="control-btn clear-btn text-gray-400 hover:text-red-500 transition duration-150"
                                    data-field="3" title="æ¸…é™¤">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.728-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <textarea id="article3"
                            class="input-textarea w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 resize-y transition duration-150"
                            placeholder="è²¼ä¸Šæˆ–è¼¸å…¥æ–‡ç« çš„çµå°¾å…§å®¹...ï¼ˆé¸å¡«ï¼‰" rows="10"></textarea>
                    </div>
                </div>
            </div>

            <!-- Merge Button -->
            <div class="merge-button-container text-center mb-12">
                <button id="mergeBtn"
                    class="merge-button inline-flex items-center justify-center px-10 py-4 border border-transparent text-lg font-medium rounded-full shadow-2xl text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition duration-300 transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:shadow-none"
                    disabled>
                    <span class="button-icon mr-3 text-2xl">ğŸ¨</span>
                    <span class="button-text">AI åˆä½µæ–‡ç« </span>
                </button>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator"
                class="loading-indicator hidden text-center mb-12 p-6 bg-white rounded-xl shadow-inner">
                <div class="spinner mx-auto mb-3"></div>
                <p class="loading-text text-xl font-medium text-gray-700">AI æ­£åœ¨æ’°å¯«ä¸­...</p>
                <p class="loading-subtext text-gray-500">æ–‡ç« æ­£åœ¨å³æ™‚ç”Ÿæˆï¼Œè«‹ç¨å€™</p>
            </div>

            <!-- Result Section -->
            <div class="articles-section">
                <h2 class="section-title text-2xl font-semibold text-gray-700 mb-6 flex items-center">
                    <span class="icon mr-2 text-3xl">ğŸ“š</span>
                    åˆä½µçµæœ
                </h2>
                <div id="articlesList"
                    class="articles-list min-h-[200px] bg-white p-6 rounded-xl shadow-xl border border-gray-200">
                    <p id="initialMessage" class="text-gray-500 italic text-center p-10">
                        åˆä½µå¾Œçš„æ–‡ç« å°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡ã€‚è«‹åœ¨ä¸Šæ–¹è¼¸å…¥æ¡†ä¸­è¼¸å…¥æ–‡ç« ç‰‡æ®µä¸¦é»æ“Šã€ŒAI åˆä½µæ–‡ç« ã€ã€‚
                    </p>
                    <!-- Merged content will be dynamically inserted here -->
                </div>

                <!-- Copy Button (Visible only when content exists) -->
                <div class="text-right mt-4">
                    <button id="copyBtn"
                        class="hidden inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 5h2a2 2 0 012 2v10a2 2 0 01-2 2H8a2 2 0 01-2-2V7a2 2 0 012-2z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11l4-4M15 11l-4-4M15 11v4M11 7h4"></path>
                        </svg>
                        è¤‡è£½æ–‡ç« 
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden">
        <span id="toastMessage"></span>
    </div>

    <script>
        // --- Utility Functions ---

        /**
         * é¡¯ç¤º Toast è¨Šæ¯
         * @param {string} message è¦é¡¯ç¤ºçš„è¨Šæ¯
         * @param {number} duration é¡¯ç¤ºæ™‚é–“ (æ¯«ç§’)
         */
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            void toast.offsetWidth;
            toast.classList.add('visible');

            setTimeout(() => {
                toast.classList.remove('visible');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300);
            }, duration);
        }

        /**
         * ä½¿ç”¨ Streaming API å³æ™‚é¡¯ç¤º AI ç”Ÿæˆçš„å…§å®¹
         * @param {string} prompt ç”¨æˆ¶æç¤ºè©
         * @param {string} systemInstruction ç³»çµ±æŒ‡ä»¤
         * @param {function} onChunk æ¯æ¬¡æ”¶åˆ°æ–°å…§å®¹æ™‚çš„å›èª¿å‡½æ•¸
         * @param {function} onComplete å®Œæˆæ™‚çš„å›èª¿å‡½æ•¸
         * @param {function} onError ç™¼ç”ŸéŒ¯èª¤æ™‚çš„å›èª¿å‡½æ•¸
         */
        async function streamAIResponse(prompt, systemInstruction, onChunk, onComplete, onError) {
            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, systemInstruction })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP Error: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);

                            if (data === '[DONE]') {
                                onComplete();
                                return;
                            }

                            try {
                                const parsed = JSON.parse(data);

                                if (parsed.error) {
                                    throw new Error(parsed.error);
                                }

                                // Extract text from Gemini streaming response
                                const text = parsed?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                                if (text) {
                                    onChunk(text);
                                }
                            } catch (parseError) {
                                console.warn('Parse error:', parseError);
                            }
                        }
                    }
                }

                onComplete();

            } catch (error) {
                console.error('Streaming Error:', error);
                onError(error);
            }
        }


        // --- Main Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const articleFields = [
                { id: 'article1', counterId: 'counter1' },
                { id: 'article2', counterId: 'counter2' },
                { id: 'article3', counterId: 'counter3' }
            ];
            const mergeBtn = document.getElementById('mergeBtn');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const articlesList = document.getElementById('articlesList');
            const initialMessage = document.getElementById('initialMessage');
            const copyBtn = document.getElementById('copyBtn');

            // --- UI Controls ---

            /** æ›´æ–°å­—æ•¸è¨ˆæ•¸å™¨ä¸¦æª¢æŸ¥æŒ‰éˆ•å•Ÿç”¨ç‹€æ…‹ */
            function updateCounterAndButton() {
                let allValid = true;
                let totalChars = 0;

                articleFields.forEach(field => {
                    const textarea = document.getElementById(field.id);
                    const counter = document.getElementById(field.counterId);
                    const count = textarea.value.trim().length;

                    counter.textContent = `${count} å­—`;
                    totalChars += count;

                    if ((field.id === 'article1' || field.id === 'article2') && count === 0) {
                        allValid = false;
                    }
                });

                mergeBtn.disabled = !allValid || totalChars < 2;
            }

            /** æ¸…é™¤æŒ‰éˆ•è™•ç†å‡½æ•¸ */
            document.querySelectorAll('.clear-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const fieldNum = e.currentTarget.getAttribute('data-field');
                    const textarea = document.getElementById(`article${fieldNum}`);
                    textarea.value = '';
                    updateCounterAndButton();
                    showToast(`æ–‡ç« ç‰‡æ®µ ${fieldNum} å·²æ¸…é™¤ã€‚`, 1500);
                });
            });

            /** è¼¸å…¥æ¡†äº‹ä»¶ç›£è½ */
            articleFields.forEach(field => {
                document.getElementById(field.id).addEventListener('input', updateCounterAndButton);
            });

            updateCounterAndButton();

            // --- Copy Button Logic ---
            copyBtn.addEventListener('click', () => {
                const mergedText = articlesList.textContent.trim();
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = mergedText;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    showToast('æ–‡ç« å·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 2000);
                } catch (err) {
                    showToast('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚', 3000);
                }
                document.body.removeChild(tempTextArea);
            });


            // --- Merge Article Logic with Streaming ---

            mergeBtn.addEventListener('click', async () => {
                const article1 = document.getElementById('article1').value.trim();
                const article2 = document.getElementById('article2').value.trim();
                const article3 = document.getElementById('article3').value.trim();

                if (!article1 || !article2) {
                    showToast('è«‹è‡³å°‘è¼¸å…¥ç¬¬ä¸€å’Œç¬¬äºŒç¯‡æ–‡ç« ç‰‡æ®µã€‚');
                    return;
                }

                // æº–å‚™æç¤ºè©
                let fullPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ä¸­æ–‡æ–‡ç« å‰µä½œè€…ã€‚ä½ çš„ä»»å‹™æ˜¯å°‡ä½¿ç”¨è€…æä¾›çš„æ–‡ç« ç‰‡æ®µæ™ºèƒ½åœ°åˆä½µæˆä¸€ç¯‡é‚è¼¯é€£è²«ã€èªæ°£ä¸€è‡´ä¸”å…§å®¹è±å¯Œçš„é•·ç¯‡æ–‡ç« ã€‚ä½ å¿…é ˆåœ¨ç‰‡æ®µä¹‹é–“æ·»åŠ éæ¸¡æ€§çš„ã€æ“´å±•æ€§çš„å…§å®¹ï¼Œç¢ºä¿æ–‡ç« çš„æµæš¢åº¦èˆ‡æ·±åº¦ã€‚è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡é€²è¡Œå‰µä½œã€‚\n\n";
                fullPrompt += "è«‹å°‡ä»¥ä¸‹æ–‡ç« ç‰‡æ®µåˆä½µç‚ºä¸€ç¯‡å®Œæ•´çš„é•·æ–‡ã€‚è«‹ä¿æŒæ–‡ç« çš„é€£è²«æ€§ä¸¦æ“´å±•å…§å®¹ï¼Œä½¿å…¶æˆç‚ºä¸€ç¯‡é‚è¼¯å®Œæ•´çš„ä½œå“ã€‚è«‹ç¢ºä¿åˆä½µå¾Œçš„æ–‡ç« åªæœ‰æ–‡å­—å…§å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•æ¨™é¡Œæˆ–æ ¼å¼èªªæ˜ï¼Œä¸”ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼ˆzh-TWï¼‰ã€‚\n\næ–‡ç« ç‰‡æ®µï¼š\n";
                fullPrompt += `1. é–‹é ­ç‰‡æ®µ (å¿…å¡«):\n---\n${article1}\n---\n`;
                fullPrompt += `2. ä¸­é–“ç‰‡æ®µ (å¿…å¡«):\n---\n${article2}\n---\n`;
                if (article3) {
                    fullPrompt += `3. çµå°¾ç‰‡æ®µ (é¸å¡«):\n---\n${article3}\n---\n`;
                }

                const systemInstruction = "Act as a professional Traditional Chinese writer. Your goal is to merge 2-3 provided article fragments into a single, cohesive, long-form article. You must write expansive, smooth transition content between the fragments. The final output must be only the merged article text, without any preambles, titles, or formatting instructions, and be in Traditional Chinese.";

                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                mergeBtn.disabled = true;
                loadingIndicator.classList.remove('hidden');
                articlesList.innerHTML = '<div id="streamingContent" class="prose max-w-none text-gray-800 whitespace-pre-wrap"></div>';
                initialMessage.classList.add('hidden');
                copyBtn.classList.add('hidden');

                const streamingContent = document.getElementById('streamingContent');
                let accumulatedText = '';

                try {
                    await streamAIResponse(
                        fullPrompt,
                        systemInstruction,
                        // onChunk - æ¯æ¬¡æ”¶åˆ°æ–°å…§å®¹æ™‚å³æ™‚é¡¯ç¤º
                        (chunk) => {
                            accumulatedText += chunk;
                            streamingContent.textContent = accumulatedText;
                        },
                        // onComplete - å®Œæˆæ™‚
                        () => {
                            loadingIndicator.classList.add('hidden');
                            copyBtn.classList.remove('hidden');
                            showToast("æ–‡ç« åˆä½µæˆåŠŸï¼", 3000);
                            updateCounterAndButton();
                        },
                        // onError - éŒ¯èª¤è™•ç†
                        (error) => {
                            console.error('Streaming Error:', error);
                            articlesList.innerHTML = `<p class="text-red-500 p-4">âŒ æ–‡ç« åˆä½µå¤±æ•—ã€‚éŒ¯èª¤è¨Šæ¯: ${error.message}</p>`;
                            loadingIndicator.classList.add('hidden');
                            initialMessage.classList.remove('hidden');
                            showToast("æ–‡ç« åˆä½µéç¨‹ä¸­ç™¼ç”Ÿé€£ç·šæˆ–æœå‹™éŒ¯èª¤ã€‚", 5000);
                            updateCounterAndButton();
                        }
                    );
                } catch (error) {
                    console.error('Merge Error:', error);
                    articlesList.innerHTML = `<p class="text-red-500 p-4">âŒ ç™¼ç”Ÿæ„å¤–éŒ¯èª¤: ${error.message}</p>`;
                    loadingIndicator.classList.add('hidden');
                    initialMessage.classList.remove('hidden');
                    updateCounterAndButton();
                }
            });
        });
    </script>
</body>

</html>